# OpenCone

Industry: iOS Development
Key skills: Combine, REST, Swift, SwiftUI
Description: Native iOS App designed to interact with the Pinecone and OpenAI APIs
GitHub: https://github.com/Gunnarguy/OpenCone
App Store: https://apps.apple.com/us/app/opencone/id6744467668

### **User-Facing Features (Current & Working)**

| Area | Key Interactions |
| --- | --- |
| **Document Upload/Import** | iOS `UIDocumentPicker` with security-scoped bookmarks to persist file access. |
| **OCR (Images)** | Uses VisionKit (`VNRecognizeTextRequest`) for text recognition. |
| **Text Extraction** | PDF: `PDFKit`; TXT/DOCX: standard file operations. |
| **Chunking** | Custom MIME-aware splitter with overlapping chunks. |
| **Embedding Generation** | Uses OpenAI `text-embedding-3-*` models to embed each chunk. |
| **Vector Storage** | Pinecone serverless indexes & namespaces store vectors. |
| **Semantic Search (RAG)** | Query → embed → Pinecone similarity → GPT-4o answer. |
| **Processing Stats** | Displays timing, token counts, and distribution per document. |
| **Real-Time Logs** | Central logger with filter/search/export. |
| **Guided Setup** | `WelcomeView` onboarding collects API keys and project ID. |
| **Settings Panel** | Model selection, chunk parameters, theme, keys. |
| **Theming** | Uses `OCDesignSystem` with multiple themes (Light, Dark, Midnight, Forest). |
| **iPhone & iPad UI** | SwiftUI responsive layouts for both devices. |

---

### **Screens / Flows (SwiftUI Views)**

**Flow Order:** `WelcomeView` → `MainView` (Tabs: Documents / Search / Logs / Settings)

- **WelcomeView** – API key entry & validation (OpenAI, Pinecone, Project ID).
- **DocumentsView** – Select/create Pinecone index & namespace; add file → process → view details (stats, errors).
- **DocumentDetailsView** – Shows per-document timing charts, token counts, chunk stats.
- **SearchView** – User query → embedding → Pinecone top-k → GPT answer + source snippets.
- **ProcessingLogView** – Real-time streaming logs with filtering.
- **SettingsView** – Manage keys, chunk size/overlap, model choices, and theme switch.
- **Theme UI Components** – `OCButton`, `OCCard`, `OCBadge` used consistently.

---

### **Services & External Integrations**

| Service | Responsibility | External Source |
| --- | --- | --- |
| **OpenAIService** | Calls embeddings & completions for RAG. | OpenAI API. |
| **PineconeService** | Create/list/select indexes; upsert/query vectors. | Pinecone API. |
| **EmbeddingService** | Orchestrates embedding pipeline around OpenAI. | OpenAI. |
| **FileProcessorService** | Handles file I/O, PDFKit extraction, Vision OCR. | iOS frameworks. |
| **TextProcessorService** | Performs chunking, token counting (via `NLTokenizer`). | Local processing. |
| **Logger** | Centralized logging with levels and timestamps. | Local. |
| **ThemeManager** | Runtime theme switching. | Local. |

*Retries and batching logic for network calls are contained within the service implementations. All external calls are asynchronous using Swift’s `async/await`.*

---

### **Data Models (Core Structs)**

| Struct/Class | Purpose | Notes |
| --- | --- | --- |
| **DocumentModel** | Tracks file metadata and processing status. | Contains `id`, `fileName`, `mimeType`, etc. |
| **ChunkModel** | Represents a text chunk. | Holds `content`, `contentHash`, token counts. |
| **ChunkMetadata** | Per-chunk metadata. | Includes page number, bounding rect, font info. |
| **EmbeddingModel** | Stores vector and meta. | Contains `vectorId`, `[Float]`, `chunkId`. |
| **PineconeVector** | Payload for Pinecone. | Contains id, values array, and metadata. |
| **SearchResultModel** | Represents a match returned from Pinecone. | Holds score, metadata, selection state. |
| **ChunkAnalytics** | Aggregated chunking statistics. | Distributions, averages, min/max counts. |
| **DocumentProcessingStats** | Timings & counts per document. | Extraction/chunking/embedding/upsert times. |

---

### **ViewModels (ObservableObjects)**

| ViewModel | Drives | Emits |
| --- | --- | --- |
| **SettingsViewModel** | API keys, chunk params, theme. | Publishes settings. |
| **DocumentsViewModel** | File list and processing pipeline. | Status and progress. |
| **SearchViewModel** | Query → results flow. | Answer text + sources. |
| **ProcessingViewModel** | Log stream and filters. | Log entries. |

---

### **Processing Pipeline (Step-by-Step)**

1. **Import** – User picks a file; a bookmark is stored to maintain secure access.
2. **Extract Text** – Choose method by MIME:
    - `PDFKit` if PDF
    - `VNRecognizeTextRequest` if image
    - `file read` if TXT/DOCX.
3. **Chunk** – The extracted text is split into overlapping chunks.
4. **Token Counting & Stats** – Use `NLTokenizer` to count tokens and compute summary statistics.
5. **Embed** – Call OpenAI’s embedding API for each chunk to obtain a vector.
6. **Upsert** – Use Pinecone’s upsert API to store each vector and its metadata.
7. **Query** – Embed the user's question and perform a similarity search in Pinecone.
8. **Answer Synthesis** – Pass retrieved chunks as context to GPT-4o to generate an answer.
9. **Display** – Show the synthesized answer with citations and update logs.

---

### **Concurrency & Reactive Pieces**

- **Swift `async/await`** – All file operations, API calls, and pipeline steps are asynchronous.
- **Combine** – `@Published` properties in ViewModels broadcast changes.
- **TaskGroup** – Used for parallel processing phases.
- **UI Reactivity** – SwiftUI automatically reflects state changes in the UI.

---

### **Persistence & Security**

| Item | Mechanism | Note |
| --- | --- | --- |
| **API Keys & Settings** | `UserDefaults` | Keychain migration is a future improvement. |
| **File Access** | Security-scoped bookmarks | Required for sandboxed persistence. |
| **Logs** | In-memory (exportable) | Could be persisted on demand. |

---

### **UI & Design System**

- **OCDesignSystem** – Provides standardized spacing, sizing, and animation constants.
- **Themes** – Four themes: Light, Dark, Midnight, Forest.
- **Components** – Custom SwiftUI components: `OCButton`, `OCCard`, `OCBadge`.
- **ThemeManager** – Enables dynamic theme switching.

---

### **Diagnostics & Telemetry**

- **Logger Service** – Centralized, searchable, and exportable logging.
- **Per-Document Stats** – Records processing durations and token counts.
- **Export Logs** – Users can export logs for external analysis.

---

### **Build & Deployment**

- **Architecture** – Pure SwiftUI + MVVM with a service layer.
- **Project** – `OpenCone.xcodeproj`.
- **Distribution** – App Store (ID 6744467668).
- **Config** – Adjustable model parameters in Settings.

---

### **Known Gaps / TODO (Current)**

- [ ]  Migrate API key storage to Keychain.
- [ ]  Optimize background processing for large batches.
- [ ]  Add granular Pinecone analytics.
- [ ]  Provide a local vector store fallback.
- [ ]  Implement automated tests and improve accessibility.
- [ ]  Add internationalization (i18n) support.

---

### **Planned Features / Backlog**

- [ ]  Local embedding model fallback.
- [ ]  Support for additional vector databases.
- [ ]  Shareable/exportable answers.
- [ ]  Background processing notifications.
- [ ]  In-app visual charts for analytics.

---

### **At-a-Glance Metrics**

| Metric | Value |
| --- | --- |
| **Total Lines of Code (LOC)** | ~6,725 |
| **Swift LOC** | ~5,771 (≈85.8%) |
| **MVVM Feature Modules** | 4 (Documents, Search, etc.) |
| **Primary Views** | 6 |
| **Service Layer Components** | 5 |
| **External APIs** | 2 (OpenAI, Pinecone) |
| **Supported File Types** | 4+ |
| **Available Themes** | 4 |